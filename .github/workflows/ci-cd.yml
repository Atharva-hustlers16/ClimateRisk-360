name: Python CI/CD

on:
  push:
    branches: [ main, develop ]
    tags:
      - 'v*.*.*'  # Trigger on version tags
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Weekly security updates check
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual triggering

# Environment variables available to all jobs and steps in this workflow
env:
  PYTHON_VERSION: '3.10'  # Default Python version for non-matrix jobs
  POETRY_VERSION: '1.5.1'  # For dependency management

# Default job settings
defaults:
  run:
    shell: bash

jobs:
  # Lint and validate code
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Run black
      run: black --check src/ tests/
    
    - name: Run flake8
      run: flake8 src/ tests/ --count --max-complexity=10 --max-line-length=127 --statistics
    
    - name: Run mypy
      run: mypy --install-types --non-interactive src/ tests/
    
    - name: Check for security vulnerabilities
      uses: pyupio/safety@v1
      with:
        api: ${{ secrets.SAFETY_API_KEY }}
        check: true
        args: --full-report

  # Run tests across multiple Python versions
  test:
    needs: lint
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
        os: [ubuntu-latest, windows-latest, macos-latest]
        exclude:
          # Skip Python 3.11 on Windows as some dependencies might not be available yet
          - python-version: '3.11'
            os: windows-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
    
    - name: Run tests with coverage
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=term
    
    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
    
    - name: Run performance tests
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      run: |
        pytest tests/performance/ -v --benchmark-only --benchmark-json=benchmark.json
    
    - name: Upload benchmark results
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.10'
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: benchmark.json
        retention-days: 5

  # Build and test the package
  build:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Verify package
      run: |
        pip install dist/*.whl
        python -c "import climaterisk360; print(f'Successfully installed {climaterisk360.__version__}')"
    
    - name: Upload package artifact
      uses: actions/upload-artifact@v3
      with:
        name: package
        path: dist/*
        retention-days: 1

  # Deploy to PyPI on tag
  deploy-pypi:
    needs: [lint, test, build]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine
    
    - name: Build package
      run: |
        python -m build
    
    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip_existing: true
        verbose: true

  # Deploy documentation
  deploy-docs:
    needs: [lint, test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mkdocs-material mkdocs-redirects mkdocs-git-revision-date-localized-plugin
    
    - name: Build and deploy documentation
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Set up git config
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # Get version from tag or use commit hash
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION=$(git rev-parse --short HEAD)
        fi
        
        # Build docs with version
        mkdocs build --site-dir public --config-file mkdocs.yml
        
        # Deploy to GitHub Pages
        cd public
        touch .nojekyll
        echo "climaterisk360.com" > CNAME
        
        git init
        git add .
        git commit -m "Deploy docs for $VERSION"
        
        git push -f https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git \
          HEAD:gh-pages

  # Nightly build and test
  nightly:
    if: github.event_name == 'schedule'
    needs: [lint, test, build]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt
    
    - name: Run dependency updates check
      run: |
        pip install pip-check
        pip-check --no-color --not-required --ignore pkg-resources
    
    - name: Check for deprecated code
      run: |
        pip install pylint
        pylint --disable=all --enable=deprecated-module,deprecated-method,deprecated-class \
          --reports=no --exit-zero src/ tests/
    
    - name: Generate dependency graph
      uses: actions/upload-artifact@v3
      with:
        name: dependency-graph
        path: |
          pipdeptree --warn silence
        retention-days: 1
